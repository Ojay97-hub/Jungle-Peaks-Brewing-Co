{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'tours/css/booking.css' %}">
{% endblock %}

{% block content %}
<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-7">
            <div class="card booking-experience shadow-lg border-0 rounded-4 p-4">
        <div class="card-body">
            <h2 class="text-center fw-bold mb-4">üìù Edit Your Tour Booking</h2>
            <p class="text-center text-muted mb-4">
                Modify your booking details below.
            </p>
            <!-- ‚úÖ Tour Availability Notice -->
            <div class="alert alert-info text-center" id="availability-alert">
                <strong>Availability:</strong> <span id="availability-text">
                    {% if available_slots > 0 %}
                        ‚úÖ {{ available_slots }} additional spots available ({{ capacity }} total capacity)
                        <br><small class="text-muted">You currently have {{ booking.guests }} attendees - you can increase your booking</small>
                    {% else %}
                        ‚ö†Ô∏è This tour is fully booked!
                    {% endif %}
                </span>
            </div>

            <form method="post" class="booking-form needs-validation" id="booking-form">
                {% csrf_token %}
                {{ form|crispy }}

                <div class="d-flex justify-content-center mt-4 gap-3">
                    <button type="submit" class="btn btn-success btn-lg shadow-sm" style="width: 180px;">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <a href="{% url 'profile' %}" class="btn btn-secondary btn-lg shadow-sm" style="width: 180px;">
                        <i class="fas fa-times-circle"></i> Cancel
                    </a>
                </div>
            </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        console.log("‚úÖ Availability Script Loaded!");

        const tourDropdown = document.getElementById("id_tour");
        const datePicker = document.getElementById("id_date");
        const guestsInput = document.getElementById("id_guests");
        const availabilityAlert = document.getElementById("availability-alert");
        const availabilityText = document.getElementById("availability-text");
        const submitButton = document.querySelector("button[type='submit']");

        function checkAvailability() {
            const selectedTour = tourDropdown.value;
            const selectedDate = datePicker.value;
            if (!selectedTour || !selectedDate) return;

            console.log(`üîÑ Checking availability for ${selectedTour} on ${selectedDate}`);

            fetch(`/tours/check-availability/?tour=${selectedTour}&date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    console.log("üìä API Response:", data);

                    if (data.available_slots > 0) {
                        // ‚úÖ Show available spots
                        availabilityAlert.style.display = "block";
                        availabilityText.innerHTML = `‚úÖ ${data.available_slots} spots left!`;
                        availabilityAlert.classList.remove("alert-danger");
                        availabilityAlert.classList.add("alert-info");
                        // Don't limit guests input for editing - user should be able to increase their own booking
                        // guestsInput.max = data.available_slots;
                        submitButton.disabled = false;  // Enable submission
                    } else {
                        // ‚ùå Show fully booked message
                        availabilityAlert.style.display = "block";
                        availabilityText.innerHTML = "‚ö†Ô∏è This tour is fully booked!";
                        availabilityAlert.classList.remove("alert-info");
                        availabilityAlert.classList.add("alert-danger");
                        submitButton.disabled = true;  // Disable submission
                    }
                })
                .catch(error => console.error("üö® Error fetching availability:", error));
        }

        // Check availability on page load
        checkAvailability();

        // Listen for changes
        tourDropdown.addEventListener("change", checkAvailability);
        datePicker.addEventListener("change", checkAvailability);
    });
</script>
{% endblock %}