{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tours/css/booking.css' %}">
<style>
    .tours-selection-section {
        margin-bottom: 2rem;
    }
    
    /* Make Master Brewer's Session full width */
    .tour-card[data-tour="master-brewer-session"] {
        grid-column: 1 / -1;
        max-width: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="tours-booking-modern">
    <div class="tours-booking-container">
        <!-- Header -->
        <div class="tours-booking-header">
            <h1 class="tours-booking-title">
                <i data-lucide="map-pin" style="width: 2rem; height: 2rem; color: #d4a574;"></i>
                Book Your Experience
            </h1>
            <p class="tours-booking-subtitle">Discover the craft brewing heritage of Jungle Peaks</p>
        </div>

        <!-- Pre-select tour if coming from tours page -->
        {% if form.initial.tour %}
        <script>
            // Pre-select the tour card based on initial form data
            document.addEventListener('DOMContentLoaded', function() {
                const initialTour = "{{ form.initial.tour }}";
                const tourCards = document.querySelectorAll('.tour-card');
                const tourRadios = document.querySelectorAll('.tour-card-radio');

                tourCards.forEach(card => {
                    const radio = card.querySelector('.tour-card-radio');
                    if (radio && radio.value === initialTour) {
                        card.classList.add('selected');
                        radio.checked = true;
                    }
                });
            });
        </script>
        {% endif %}

        <!-- Tour Selection Section (Outside Form) -->
        <div class="tours-selection-section">
            <h3 class="section-title">
                <i data-lucide="compass" class="section-icon"></i>
                Select Your Experience
            </h3>

            <div class="tour-cards-grid">
                <!-- Guided Brewery Tour -->
                <div class="tour-card" data-tour="guided-brewery-tour">
                    <input type="radio" name="tour" value="guided" class="tour-card-radio" id="tour-guided" form="booking-form">
                    <div class="tour-card-header">
                        <div class="tour-card-icon">
                            <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="tour-card-price">¬£25</div>
                    </div>
                    <h4 class="tour-card-title">Guided Brewery Tour</h4>
                    <p class="tour-card-description">
                        Join our expert guides for an in-depth look at our brewing process, from grain to glass.
                    </p>
                    <div class="tour-card-features">
                        <span class="tour-feature">
                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                            2 hours
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="glass-water" style="width: 12px; height: 12px;"></i>
                            Includes tastings
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="award" style="width: 12px; height: 12px;"></i>
                            Expert guide
                        </span>
                    </div>
                </div>

                <!-- Sunset Tour -->
                <div class="tour-card" data-tour="sunset-tour">
                    <input type="radio" name="tour" value="sunset" class="tour-card-radio" id="tour-sunset" form="booking-form">
                    <div class="tour-card-header">
                        <div class="tour-card-icon">
                            <i data-lucide="sunset" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="tour-card-price">¬£35</div>
                    </div>
                    <h4 class="tour-card-title">Sunset Tour</h4>
                    <p class="tour-card-description">
                        Experience the beauty of our brewery at sunset, complete with a tasting session on our terrace.
                    </p>
                    <div class="tour-card-features">
                        <span class="tour-feature">
                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                            2.5 hours
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="mountain" style="width: 12px; height: 12px;"></i>
                            Terrace views
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="glass-water" style="width: 12px; height: 12px;"></i>
                            Premium tastings
                        </span>
                    </div>
                </div>

                <!-- Craft Beer Tasting -->
                <div class="tour-card" data-tour="craft-beer-tasting">
                    <input type="radio" name="tour" value="craft_tasting" class="tour-card-radio" id="tour-craft_tasting" form="booking-form">
                    <div class="tour-card-header">
                        <div class="tour-card-icon">
                            <i data-lucide="beer" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="tour-card-price">¬£20</div>
                    </div>
                    <h4 class="tour-card-title">Craft Beer Tasting</h4>
                    <p class="tour-card-description">
                        Sample a variety of our finest craft beers, each brewed with locally sourced ingredients.
                    </p>
                    <div class="tour-card-features">
                        <span class="tour-feature">
                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                            1.5 hours
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="glass-water" style="width: 12px; height: 12px;"></i>
                            6 beer samples
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="leaf" style="width: 12px; height: 12px;"></i>
                            Local ingredients
                        </span>
                    </div>
                </div>

                <!-- Seasonal Selection -->
                <div class="tour-card" data-tour="seasonal-selection">
                    <input type="radio" name="tour" value="seasonal" class="tour-card-radio" id="tour-seasonal" form="booking-form">
                    <div class="tour-card-header">
                        <div class="tour-card-icon">
                            <i data-lucide="calendar" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="tour-card-price">¬£28</div>
                    </div>
                    <h4 class="tour-card-title">Seasonal Selection</h4>
                    <p class="tour-card-description">
                        Enjoy a tasting session featuring our seasonal beers, crafted with unique and exciting flavors.
                    </p>
                    <div class="tour-card-features">
                        <span class="tour-feature">
                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                            1.5 hours
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="sparkles" style="width: 12px; height: 12px;"></i>
                            Unique flavors
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="glass-water" style="width: 12px; height: 12px;"></i>
                            5 seasonal beers
                        </span>
                    </div>
                </div>

                <!-- Master Brewer's Session (Full Width) -->
                <div class="tour-card" data-tour="master-brewer-session">
                    <input type="radio" name="tour" value="brewer_session" class="tour-card-radio" id="tour-brewer_session" form="booking-form">
                    <div class="tour-card-header">
                        <div class="tour-card-icon">
                            <i data-lucide="graduation-cap" style="width: 24px; height: 24px;"></i>
                        </div>
                        <div class="tour-card-price">¬£45</div>
                    </div>
                    <h4 class="tour-card-title">Master Brewer's Session</h4>
                    <p class="tour-card-description">
                        Participate in an educational tasting session led by our master brewer, exploring a range of beer styles and flavors.
                    </p>
                    <div class="tour-card-features">
                        <span class="tour-feature">
                            <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                            3 hours
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="book-open" style="width: 12px; height: 12px;"></i>
                            Educational
                        </span>
                        <span class="tour-feature">
                            <i data-lucide="glass-water" style="width: 12px; height: 12px;"></i>
                            8 beer styles
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Booking Form -->
        <div class="tours-booking-card">
            <!-- Availability Notice -->
            <div class="availability-alert" id="availability-alert">
                <strong>Availability:</strong> <span id="availability-text"></span>
            </div>

            <form method="post" class="booking-form needs-validation" id="booking-form">
                {% csrf_token %}

                <!-- Booking Details -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i data-lucide="calendar" class="section-icon"></i>
                        When & How Many
                    </h3>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="{{ form.date.id_for_label }}" class="form-label fw-semibold">
                                <i data-lucide="calendar-days" style="width: 16px; height: 16px; color: #d4a574;"></i>
                                Date *
                            </label>
                            {{ form.date }}
                        </div>
                        <div class="col-md-6">
                            <label for="{{ form.guests.id_for_label }}" class="form-label fw-semibold">
                                <i data-lucide="users" style="width: 16px; height: 16px; color: #d4a574;"></i>
                                Number of Guests *
                            </label>
                            {{ form.guests }}
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i data-lucide="user" class="section-icon"></i>
                        Your Details
                    </h3>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.name }}
                                <label for="{{ form.name.id_for_label }}">Full Name *</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.email }}
                                <label for="{{ form.email.id_for_label }}">Email Address *</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                {{ form.phone }}
                                <label for="{{ form.phone.id_for_label }}">Phone Number *</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Special Requirements -->
                {% if form.special_requirements %}
                <div class="form-section">
                    <h3 class="section-title">
                        <i data-lucide="message-square" class="section-icon"></i>
                        Special Requirements
                    </h3>

                    <div class="form-floating">
                        {{ form.special_requirements }}
                        <label for="{{ form.special_requirements.id_for_label }}">Any special requirements or dietary restrictions?</label>
                    </div>
                </div>
                {% endif %}

                <!-- Add to Cart Button -->
                <button type="button" class="btn-tours-booking" id="add-to-cart-btn">
                    <i data-lucide="shopping-cart" style="width: 20px; height: 20px;"></i>
                    Add to Cart
                </button>

                <!-- Features -->
                <div class="tours-features">
                    <div class="feature-item">
                        <i data-lucide="clock" class="feature-icon"></i>
                        <span>Real-time availability</span>
                    </div>
                    <div class="feature-item">
                        <i data-lucide="shield-check" class="feature-icon"></i>
                        <span>Secure booking</span>
                    </div>
                    <div class="feature-item">
                        <i data-lucide="phone" class="feature-icon"></i>
                        <span>Expert guides</span>
                    </div>
                    <div class="feature-item">
                        <i data-lucide="calendar-x" class="feature-icon"></i>
                        <span>Free cancellation</span>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    
        // Add form validation classes
        const form = document.querySelector('form');
        const inputs = form.querySelectorAll('input, select, textarea');
    
        inputs.forEach(input => {
            // Add Bootstrap classes for better styling
            if (input.type === 'text' || input.type === 'email' || input.type === 'tel' || input.tagName === 'TEXTAREA') {
                input.classList.add('form-control');
            } else if (input.tagName === 'SELECT') {
                input.classList.add('form-select');
            }
    
            // Add date input styling
            if (input.type === 'date') {
                input.classList.add('form-control');
            }
        });
    
        // Tour card selection functionality
        const tourCards = document.querySelectorAll('.tour-card');
        const tourRadios = document.querySelectorAll('.tour-card-radio');
    
        function selectTourCard(selectedCard) {
            // Remove selected class from all cards
            tourCards.forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            selectedCard.classList.add('selected');
            
            // Check the corresponding radio button
            const radio = selectedCard.querySelector('.tour-card-radio');
            radio.checked = true;
    
            // Trigger availability check
            checkAvailability();
        }
    
        // Add click handlers to tour cards
        tourCards.forEach(card => {
            card.addEventListener('click', () => {
                selectTourCard(card);
                // Also check availability when tour is selected
                setTimeout(checkAvailability, 100);
            });
        });
    
        // Handle radio button changes (for keyboard navigation)
        tourRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.checked) {
                    const card = this.closest('.tour-card');
                    selectTourCard(card);
                    // Also check availability when radio button is selected
                    setTimeout(checkAvailability, 100);
                }
            });
        });
    
        // Availability checking functionality
        const datePicker = document.getElementById("id_date");
        const guestsInput = document.getElementById("id_guests");
        const availabilityAlert = document.getElementById("availability-alert");
        const availabilityText = document.getElementById("availability-text");
    
        function checkAvailability() {
            const selectedTourRadio = document.querySelector('input[name="tour"]:checked');
            const selectedDate = datePicker ? datePicker.value : '';
            
            if (!selectedTourRadio || !selectedDate) {
                availabilityAlert.style.display = "none";
                return;
            }
    
            const selectedTour = selectedTourRadio.value;
            console.log(`üîÑ Checking availability for ${selectedTour} on ${selectedDate}`);
    
            fetch(`/tours/check-availability/?tour=${selectedTour}&date=${selectedDate}`)
                .then(response => response.json())
                .then(data => {
                    console.log("üìä API Response:", data);
    
                    if (data.available_slots > 0) {
                        // ‚úÖ Show available spots
                        availabilityAlert.style.display = "block";
                        availabilityText.innerHTML = `‚úÖ ${data.available_slots} spots available!`;
                        availabilityAlert.classList.remove("alert-danger");
                        availabilityAlert.classList.add("alert-info");
                        if (guestsInput) {
                            guestsInput.max = data.available_slots;
                        }
                        const addToCartBtn = document.getElementById("add-to-cart-btn");
                        if (addToCartBtn) addToCartBtn.disabled = false;
                    } else {
                        // ‚ùå Show fully booked message
                        availabilityAlert.style.display = "block";
                        availabilityText.innerHTML = "‚ö†Ô∏è This tour is fully booked for this date!";
                        availabilityAlert.classList.remove("alert-info");
                        availabilityAlert.classList.add("alert-danger");
                        const addToCartBtn = document.getElementById("add-to-cart-btn");
                        if (addToCartBtn) addToCartBtn.disabled = true;
                    }
                })
                .catch(error => {
                    console.error("üö® Error fetching availability:", error);
                    availabilityAlert.style.display = "none";
                });
        }
    
        // Listen for changes
        if (datePicker) datePicker.addEventListener("change", checkAvailability);
    
        // Add to Cart functionality
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        if (addToCartBtn) {
            // Ensure button is enabled by default
            addToCartBtn.disabled = false;
            addToCartBtn.addEventListener('click', function() {
                console.log('üõí Add to Cart button clicked!');

                const selectedTourRadio = document.querySelector('input[name="tour"]:checked');
                const selectedDate = datePicker ? datePicker.value : '';
                const guests = guestsInput ? guestsInput.value : 1;

                console.log('üìã Form data:', {
                    selectedTour: selectedTourRadio ? selectedTourRadio.value : 'none',
                    selectedDate: selectedDate,
                    guests: guests
                });

                if (!selectedTourRadio) {
                    alert('Please select a tour experience.');
                    return;
                }

                if (!selectedDate) {
                    alert('Please select a date.');
                    return;
                }

                if (!guests || guests < 1) {
                    alert('Please enter the number of guests.');
                    return;
                }

                // Show loading state
                addToCartBtn.innerHTML = '<i data-lucide="loader-2" style="width: 20px; height: 20px; animation: spin 1s linear infinite;"></i> Adding to Cart...';
                addToCartBtn.disabled = true;

                // Re-initialize icons for the loading spinner
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Redirect to add tour to cart (By submitting form)
                // We submit the form to the view, which will handle validation and session storage
                // before redirecting to the cart view.
                form.submit();
            });
        } else {
            console.error('‚ùå Add to Cart button not found!');
        }
    });
</script>
{% endblock %}