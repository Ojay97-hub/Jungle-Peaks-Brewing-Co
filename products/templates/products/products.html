{% extends "base.html" %}
{% load static imgix_tags %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'products/css/products.css' %}">
{% endblock %}

{% block breadcrumbs %}
    <div class="container mt-3">
        <nav aria-label="Breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
                <li class="breadcrumb-item active" aria-current="page">Shop</li>
            </ol>
        </nav>
    </div>
{% endblock %}

{% block content %}
    <section class="container my-4">
        <div class="shop-hero">
            <div class="shop-hero__content">
                <h1 class="mb-2">Jungle Peaks Brewing Shop</h1>
                <p class="lead mb-2">Explore freshly canned releases, taproom favourites and sustainable merchandise from the heart of the rainforest.</p>
                <div class="shop-hero__meta">
                    <span class="badge">New small-batch drops weekly</span>
                    <span class="badge">Free delivery over £{{ free_delivery_threshold }}</span>
                </div>
            </div>
        </div>
    </section>

    <section class="container my-4">
        <div class="filter-card">
            <form id="product-filters" method="get" class="row g-3 align-items-end">
                {% if search_term %}
                    <input type="hidden" name="q" value="{{ search_term }}">
                {% endif %}
                <div class="col-12 col-md-4">
                    <label for="filter-category" class="form-label">Category</label>
                    <select id="filter-category" name="category" class="form-select">
                        <option value="">All categories</option>
                        {% for category in all_categories %}
                            <option value="{{ category.name }}" {% if current_categories and category.name in current_categories %}selected{% endif %}>{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <label for="filter-sort" class="form-label">Sort by</label>
                    <select id="filter-sort" name="sort" class="form-select">
                        <option value="" {% if not current_sorting %}selected{% endif %}>Recommended</option>
                        <option value="price_asc" {% if current_sorting == 'price_asc' %}selected{% endif %}>Price (low to high)</option>
                        <option value="price_desc" {% if current_sorting == 'price_desc' %}selected{% endif %}>Price (high to low)</option>
                        <option value="rating_desc" {% if current_sorting == 'rating_desc' %}selected{% endif %}>Rating (high to low)</option>
                        <option value="rating_asc" {% if current_sorting == 'rating_asc' %}selected{% endif %}>Rating (low to high)</option>
                        <option value="name" {% if current_sorting == 'name' %}selected{% endif %}>Name A–Z</option>
                        <option value="category" {% if current_sorting == 'category' %}selected{% endif %}>Category</option>
                    </select>
                </div>
                <div class="col-12 col-md-4">
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">Apply filters</button>
                        {% if request.GET %}
                            <a href="{% url 'products' %}" class="btn btn-light">Clear</a>
                        {% endif %}
                        <span class="text-muted" aria-live="polite">
                            {{ products|length }} product{% if products|length != 1 %}s{% endif %} found
                        </span>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <section class="container my-5" aria-live="polite">
        {% if products %}
            <div id="product-skeletons" class="skeleton-grid" aria-hidden="true">
                {% for _ in "123" %}
                    <div class="skeleton-card">
                        <div class="image-placeholder loading-skeleton"></div>
                        <div class="content-placeholder">
                            <div class="loading-skeleton" style="height: 1.1rem;"></div>
                            <div class="loading-skeleton" style="height: 0.9rem;"></div>
                            <div class="loading-skeleton" style="height: 0.9rem; width: 60%;"></div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div id="product-grid" class="product-grid" data-loaded="false">
                {% for product in products %}
                    <div class="card product-card h-100">
                        <div class="ratio ratio-4x3">
                            {% if product.image_url %}
                                {% if "http" in product.image_url %}
                                    <img src="{{ product.image_url }}" alt="{{ product.name }}" class="card-img-top" loading="lazy">
                                {% else %}
                                    <img src="{% imgix_url product.image_url params='w=600&h=450&fit=crop&auto=format,compress&q=75' %}" alt="{{ product.name }}" class="card-img-top" loading="lazy">
                                {% endif %}
                            {% elif product.image %}
                                <img src="{% imgix_url product.image.name params='w=600&h=450&fit=crop&auto=format,compress&q=75' %}" alt="{{ product.name }}" class="card-img-top" loading="lazy">
                            {% else %}
                                <img src="{% imgix_url 'noimage.png' params='w=600&h=450&fit=crop&auto=format,compress&q=75' %}" alt="{{ product.name }}" class="card-img-top" loading="lazy">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <span class="category-badge">{{ product.category.name }}</span>
                            <h3 class="h5"><a href="{% url 'product_detail' product.id %}" class="text-decoration-none">{{ product.name }}</a></h3>
                            <div class="product-meta">
                                <span class="product-price">£{{ product.price }}</span>
                                {% if product.rating %}
                                    <span class="text-muted"><i class="fas fa-star text-warning"></i> {{ product.rating }} / 5</span>
                                {% else %}
                                    <span class="text-muted">Not yet rated</span>
                                {% endif %}
                            </div>
                            {% if product.abv %}
                                <p class="text-small">ABV {{ product.abv }}%</p>
                            {% endif %}
                            <p class="text-small">{{ product.description|truncatewords:18 }}</p>
                        </div>
                        <div class="card-footer bg-transparent border-0">
                            <form method="post" action="{% url 'add_to_bag' product.id %}">
                                {% csrf_token %}
                                <input type="hidden" name="redirect_url" value="{{ request.get_full_path }}">
                                <div class="product-actions">
                                    <div class="quantity-stepper" role="group" aria-label="Select quantity for {{ product.name }}">
                                        <button type="button" class="btn btn-light btn-sm stepper" data-step="-1" data-target="qty-{{ product.id }}" aria-label="Decrease quantity for {{ product.name }}">
                                            <span aria-hidden="true">−</span>
                                        </button>
                                        <input id="qty-{{ product.id }}" class="form-control" type="number" name="quantity" value="1" min="1" max="99" aria-describedby="qty-help-{{ product.id }}">
                                        <button type="button" class="btn btn-light btn-sm stepper" data-step="1" data-target="qty-{{ product.id }}" aria-label="Increase quantity for {{ product.name }}">
                                            <span aria-hidden="true">+</span>
                                        </button>
                                    </div>
                                    <button type="submit" class="btn btn-primary flex-grow-1">Add to bag</button>
                                </div>
                                <p id="qty-help-{{ product.id }}" class="form-text">Maximum 99 items per order.</p>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <h3>Nothing matches those filters</h3>
                <p>Try adjusting your filters or browse our full collection of small batch brews and taproom gear.</p>
                <a href="{% url 'products' %}" class="btn btn-primary">Browse all products</a>
            </div>
        {% endif %}
    </section>

    <button type="button" class="btn btn-primary back-to-top d-none" id="btn-back-to-top" aria-label="Back to top">
        <i class="fas fa-arrow-up"></i>
    </button>
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const skeletons = document.getElementById('product-skeletons');
            const grid = document.getElementById('product-grid');
            if (skeletons && grid) {
                requestAnimationFrame(() => {
                    skeletons.setAttribute('hidden', 'hidden');
                    grid.dataset.loaded = 'true';
                });
            }

            document.querySelectorAll('.stepper').forEach(button => {
                button.addEventListener('click', () => {
                    const target = document.getElementById(button.dataset.target);
                    if (!target) {
                        return;
                    }
                    const step = parseInt(button.dataset.step, 10);
                    const current = parseInt(target.value || '0', 10);
                    const min = parseInt(target.getAttribute('min') || '1', 10);
                    const max = parseInt(target.getAttribute('max') || '99', 10);
                    const next = Math.min(Math.max(current + step, min), max);
                    target.value = next;
                    target.dispatchEvent(new Event('change'));
                });
            });

            const backToTop = document.getElementById('btn-back-to-top');
            const toggleBackToTop = () => {
                if (window.scrollY > 200) {
                    backToTop.classList.remove('d-none');
                } else {
                    backToTop.classList.add('d-none');
                }
            };
            toggleBackToTop();
            window.addEventListener('scroll', toggleBackToTop);
            backToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    </script>
{% endblock %}
